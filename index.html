<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 2rem;
    }
    .mapping-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 10px;
      background-color: #f9f9f9;
    }
    .mapping-container div {
      flex: 1;
      padding: 0 1rem;
    }
    .mapping-container label {
      font-weight: bold;
    }
    .arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #007bff;
      font-size: 1.2rem;
    }
    .progress-container {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Template Document Generator</h1>

    <!-- Upload Section -->
    <div id="uploadSection">
      <div class="mb-3">
        <label for="templateUpload" class="form-label">Upload Template (.docx)</label>
        <input class="form-control" type="file" id="templateUpload" accept=".docx">
      </div>
      <div class="mb-3">
        <label for="excelUpload" class="form-label">Upload Excel File (.xlsx)</label>
        <input class="form-control" type="file" id="excelUpload" accept=".xlsx">
      </div>
      <button class="btn btn-primary" onclick="processFiles()">Next</button>
    </div>

    <!-- Mapping Section -->
    <div id="mappingSection" class="mt-5" style="display: none;">
      <h3>Field Mapping</h3>
      <div id="mappingContainer" class="mt-3"></div>
      <button class="btn btn-primary me-2" onclick="previewDocument()">Preview</button>
      <button class="btn btn-success" onclick="generateDocuments()">Generate Documents</button>
    </div>

    <!-- Progress Section -->
    <div id="progressSection" class="mt-5 progress-container">
      <h3>Generating Documents</h3>
      <div class="progress">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
      </div>
      <a href="#" id="downloadLink" class="btn btn-primary mt-3" style="display: none;">Download ZIP</a>
    </div>

    <!-- Preview Section -->
    <div id="previewSection" class="mt-5" style="display: none;">
      <h3>Preview Document</h3>
      <a href="#" id="previewDownloadLink" class="btn btn-primary mt-3" style="display: none;">Download Preview Document</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    let templateDocx = null;
    let excelData = [];
    let placeholders = new Set();
    let fieldMapping = {};
    let availableExcelKeys = [];

    async function processFiles() {
      const templateInput = document.getElementById('templateUpload');
      const excelInput = document.getElementById('excelUpload');
      if (!templateInput.files.length || !excelInput.files.length) {
        alert("Please upload both template and Excel file.");
        return;
      }
      templateDocx = templateInput.files[0];

      // Use JSZip to read the .docx file and extract word/document.xml
      const zip = new JSZip();
      const zipData = await zip.loadAsync(templateDocx);
      const documentXml = await zipData.file("word/document.xml").async("string");

      // Extract placeholders from the document.xml content
      const matches = [...documentXml.matchAll(/[\[<]([a-zA-Z0-9_]+)[\]>]/g)];
      placeholders = new Set(matches.map(m => m[1]));

      // Log the detected placeholders
      console.log("Detected placeholders from template:", Array.from(placeholders));

      const fileReader = new FileReader();
      fileReader.onload = function(e) {
        const workbook = XLSX.read(e.target.result, { type: 'binary' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        excelData = XLSX.utils.sheet_to_json(worksheet);
        availableExcelKeys = Object.keys(excelData[0]);
        showMappingUI();
      };
      fileReader.readAsBinaryString(excelInput.files[0]);
    }

    function showMappingUI() {
      document.getElementById('uploadSection').style.display = 'none';
      document.getElementById('mappingSection').style.display = 'block';
      const container = document.getElementById('mappingContainer');
      container.innerHTML = '';

      const mappedKeys = new Set();
      placeholders.forEach((key) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'mapping-container';

        // Exact match for automatic mapping
        let autoMap = availableExcelKeys.find(k => k.toLowerCase() === key.toLowerCase());

        if (autoMap && !mappedKeys.has(autoMap)) {
          mappedKeys.add(autoMap);
        } else {
          autoMap = '';
        }

        wrapper.innerHTML = `
          <div>
            <label>Source Column (Template): ${key}</label>
          </div>
          <div class="arrow">â†’</div>
          <div>
            <label>Destination Column (Excel)</label>
            <select class="form-select" id="map-${key}">
              <option value="">-- Select Excel Field --</option>
              ${availableExcelKeys.map(col => {
                const disabled = mappedKeys.has(col) && col !== autoMap ? 'disabled' : '';
                return `<option value="${col}" ${col === autoMap ? 'selected' : ''} ${disabled}>${col}</option>`;
              }).join('')}
            </select>
          </div>
        `;
        container.appendChild(wrapper);
      });
    }

    async function previewDocument() {
      fieldMapping = {};
      placeholders.forEach(key => {
        const value = document.getElementById(`map-${key}`).value;
        if (value) fieldMapping[key] = value;
      });

      if (Object.keys(fieldMapping).length !== placeholders.size) {
        alert("Please map all fields before previewing.");
        return;
      }

      document.getElementById('previewSection').style.display = 'block';
      const zip = new JSZip();
      const zipData = await zip.loadAsync(templateDocx);
      let documentXml = await zipData.file("word/document.xml").async("string");

      // Replace placeholders in the document.xml content
      for (const key in fieldMapping) {
        const value = excelData[0][fieldMapping[key]] || '';
        documentXml = documentXml.replaceAll(`[${key}]`, value).replaceAll(`<${key}>`, value);
      }

      // Update the document.xml in the zip
      zipData.file("word/document.xml", documentXml);

      // Generate the new .docx file
      const blob = await zipData.generateAsync({ type: 'blob' });
      const link = document.getElementById('previewDownloadLink');
      link.href = URL.createObjectURL(blob);
      link.download = "Preview_Document.docx";
      link.style.display = 'inline-block';
    }

    async function generateDocuments() {
      fieldMapping = {};
      placeholders.forEach(key => {
        const value = document.getElementById(`map-${key}`).value;
        if (value) fieldMapping[key] = value;
      });

      if (Object.keys(fieldMapping).length !== placeholders.size) {
        alert("Please map all fields.");
        return;
      }

      document.getElementById('mappingSection').style.display = 'none';
      document.getElementById('progressSection').style.display = 'block';
      const zip = new JSZip();

      // Load the original template ZIP
      const templateZip = new JSZip();
      const templateZipData = await templateZip.loadAsync(templateDocx);
      const originalDocumentXml = await templateZipData.file("word/document.xml").async("string");

      for (let i = 0; i < excelData.length; i++) {
        // Create a fresh copy of the template ZIP for each document
        const docZip = new JSZip();
        const docZipData = await docZip.loadAsync(templateDocx);
        let documentXml = originalDocumentXml; // Start with the original document.xml content

        // Replace placeholders with the current row's data
        for (const key in fieldMapping) {
          const value = excelData[i][fieldMapping[key]] || '';
          documentXml = documentXml.replaceAll(`[${key}]`, value).replaceAll(`<${key}>`, value);
        }

        // Update the document.xml in the new ZIP
        docZipData.file("word/document.xml", documentXml);
        const docBlob = await docZipData.generateAsync({ type: 'blob' });
        zip.file(`Document_${i + 1}.docx`, docBlob);

        const progress = ((i + 1) / excelData.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressBar').textContent = Math.round(progress) + '%';
      }

      zip.generateAsync({ type: 'blob' }).then(function(content) {
        const link = document.getElementById('downloadLink');
        link.href = URL.createObjectURL(content);
        link.download = "Documents.zip";
        link.style.display = 'inline-block';
      });
    }
  </script>
</body>
</html>